# Technical Implementation Plan: Safe AI Editing Improvements

This plan turns the high-level stabilization goals in `fixing_ai.md` into actionable workstreams with trackable tasks.

## Workstream A — Snapshot Integrity Guardrails
- [x] **Bridge contract update**: Patch the existing bridge in `src/tinkerbell/services/bridge.py` (wired through `WorkspaceBridgeRouter`) to treat `document_version`/`content_hash` as mandatory, compare them to the active `DocumentState`, and continue using/renaming `DocumentVersionMismatchError` instead of inventing a second exception. Reject range patches whenever either the supplied `match_text` **or** `content_hash`/`chunk_hash` disagree with the live document so we never “best effort” corrupted edits, and bubble the error through the router so tab-aware callers get the right `tab_id` plus an `edit_rejected` telemetry payload. _(Completed Nov 20, 2025 — see `src/tinkerbell/services/bridge.py`, `tests/test_bridge.py`.)_
- [x] **Tool propagation**: Ensure every code path that can enqueue edits (not just `DocumentEditTool`/`DocumentApplyPatchTool`, but also helpers like `SearchReplaceTool`) carries both `document_version` and `content_hash` from the freshest snapshot, converts inline directives into diff/patch payloads, and drops legacy inline actions entirely so the bridge only ever receives guarded patch traffic. _(Completed Nov 21, 2025 — `DocumentEditTool` now auto-converts inline directives into guarded patches, `SearchReplaceTool` already emits patch payloads, and `DocumentBridge` rejects inline directives outright; see `src/tinkerbell/ai/tools/document_edit.py`, `src/tinkerbell/services/bridge.py`, `tests/test_ai_tools.py`, `tests/test_bridge.py`.)_
- [x] **Agent retry path**: Teach the controller (`src/tinkerbell/ai/orchestration/controller.py`) to catch `DocumentVersionMismatchError`, force a new `document_snapshot`, rebuild the diff once, and raise a structured warning/telemetry record on the second failure so the operator sees why the edit was dropped. _(Completed Nov 20, 2025 — controller auto-retries with `document_edit.retry` telemetry; see `src/tinkerbell/ai/orchestration/controller.py`, `tests/test_ai_controller.py`.)_
- [x] **Telemetry**: Reuse the existing `patch.apply` event (adding tab metadata + cause codes inside `WorkspaceBridgeRouter`) and emit a sibling `edit_rejected` event whenever the bridge refuses an edit so dashboards can correlate `document_id`, `tab_id`, `reason`, and whether it was `hash_mismatch`, `chunk_hash_mismatch`, `inspector_failure`, or `retry_exhausted` without duplicating signals. _(Completed Nov 21, 2025 — bridge + router now emit structured metadata with tab identifiers; see `src/tinkerbell/services/bridge.py`, `src/tinkerbell/services/bridge_router.py`, `tests/test_bridge.py`, `tests/test_bridge_router.py`.)_
- [x] **Hash enforcement plumbing**: Preserve `content_hash`/`chunk_hash` metadata on `PatchRangePayload`/`RangePatch`, compare them to the live document or chunk manifest before applying, and convert any mismatch or `PatchApplyError` raised during range validation into `DocumentVersionMismatchError` so retry logic sees a single, typed failure. _(Completed Nov 20, 2025 — `src/tinkerbell/editor/patches.py`, `src/tinkerbell/services/bridge.py`.)_
- [x] **Bridge failure metadata**: Extend `WorkspaceBridgeRouter`/bridge failure listeners to attach `tab_id`, rejection reason, and range stats to both `patch.apply` and `edit_rejected` telemetry payloads before dispatching UI notices, ensuring the chat panel and dashboards see the same cause codes. _(Completed Nov 21, 2025 — DocumentBridge stores structured failure metadata, router forwards it (plus `tab_id`) to UI + telemetry listeners, and the main window surfaces the cause codes.)_

## Workstream B — Range-Safe Editing
- [x] **Range abstraction**: Introduce a `TextRange` dataclass (e.g., `src/tinkerbell/documents/ranges.py`) that can serialize to the existing JSON schema in `tinkerbell/chat/commands.py` so `EditDirective.target_range`, diffs, overlays, and tests speak one format. This becomes the single source of truth once inline actions go away. _(Completed Nov 20, 2025 — `TextRange` now lives in `src/tinkerbell/documents/ranges.py`, `EditDirective`/`EditContext` coerce into it, and bridge + tool pathways emit serialized ranges.)_
- [x] **Patch-only bridge**: Remove legacy inline action paths from `DocumentEditTool`, `DocumentBridge`, and Search/Replace helpers so every edit is expressed as a diff/range patch that already carries hashes and `TextRange` metadata. _(Completed Nov 20, 2025 — DocumentEditTool/SearchReplace now emit canonical range metadata, and `DocumentBridge` derives `TextRange` hints from patch payloads so telemetry/failure listeners always receive the serialized range; see `src/tinkerbell/ai/tools/search_replace.py`, `src/tinkerbell/services/bridge.py`, `tests/test_bridge.py`.)_
- [x] **Server-side normalization**: When an edit arrives with raw offsets (including those generated by `SearchReplaceTool`), expand them to the nearest word/paragraph boundaries inside the bridge before applying changes. _(Completed Dec 3, 2025 — `DocumentBridge` now widens streamed patch ranges to word/paragraph boundaries, reuses the widened bounds for telemetry/target range metadata, and the new tests in `tests/test_bridge.py` cover word/paragraph expansion.)_
- [x] **Whole-document replace pathway**: Add an explicit `replace_all` or `range="document"` pathway in `DocumentEditTool` so whole-file swaps no longer rely on implicit `(0, len(text))` tuples that bypass validation, and ensure it emits a diff/patch instead of inline content updates. _(Completed Dec 3, 2025 — `DocumentEditTool` now recognizes the `target_range="document"` sentinel (plus a schema entry) and converts it into a full-document range patch with coverage tests in `tests/test_ai_tools.py`.)_
- [x] **CRDT/OT compatibility review**: Validate the new `TextRange` plumbing with the undo/redo stack in `EditorWidget` and ensure future CRDT/OT adapters can reuse the same serialization contract. _(Completed Dec 3, 2025 — `SelectionRange` now round-trips through `TextRange`, the editor undo/redo history stores canonical ranges, and new tests in `tests/test_editor_widget.py` verify TextRange inputs and history restoration.)_
- [x] **Schema migration**: Update `DIRECTIVE_SCHEMA`, directive validators, and review/overlay code to emit and accept the new `TextRange` structure while keeping tuple compatibility via adapters during the rollout so existing tools/tests don’t break mid-flight. _(Completed Dec 4, 2025 — review overlays, AI review sessions, and both window layers now traffic `TextRange` instances directly while adapters continue to coerce legacy tuples/lists; see `src/tinkerbell/ui/review_overlay_manager.py`, `src/tinkerbell/ui/ai_review_controller.py`, `src/tinkerbell/ui/main_window.py`, and `src/tinkerbell/main_window.py`.)_
- [x] **Pre-apply normalization**: Move word/paragraph boundary expansion into the diff/range builders (`DocumentApplyPatchTool`, `SearchReplaceTool`, etc.) so the payload reaching the bridge already has aligned `match_text`/hashes; add unit tests that prove widened ranges still validate. _(Completed Nov 20, 2025 — `DocumentApplyPatchTool` (including streamed diff paths) and `DocumentEditTool` now call `normalize_text_range`/`compose_normalized_replacement` before diff construction, and new tests cover both standard and streamed edits.)_

## Workstream C — Duplicate/Corruption Detection
- [x] **Diff analyzer**: Build a `PostEditInspector` helper (e.g., `src/tinkerbell/editor/post_edit_inspector.py`) that consumes the `pre_edit_snapshot`/`patch_result` already produced by `DocumentBridge`, computes rolling paragraph hashes + token counts, and flags duplicated paragraphs, dropped boundaries, or split tokens. _(Completed Nov 20, 2025 — see `src/tinkerbell/editor/post_edit_inspector.py`, `tests/test_bridge.py` covers detector wiring.)_
- [x] **Auto-revert hook**: Wire the inspector into `DocumentBridge` immediately after the patch/inline edit but before `_notify_listeners`; if it flags anomalies, restore the saved snapshot, emit telemetry, raise `DocumentVersionMismatchError` (or a subclass), and treat the edit as rejected so nothing “mostly applies.” _(Completed Nov 21, 2025 — `src/tinkerbell/services/bridge.py` now runs the inspector, rolls back via `_restore_document_snapshot`, and surfaces diagnostics through `edit_rejected` telemetry.)_
- [x] **User feedback**: Added guardrail badges + assistant notices so inspector rejections surface in both the chat pane and status bar, including concise summaries of duplicate/boundary diagnostics. _(Completed — `src/tinkerbell/chat/chat_panel.py`, `src/tinkerbell/widgets/status_bar.py`, `src/tinkerbell/ui/main_window.py`, `tests/test_chat_panel.py`, `tests/test_main_window.py`.)_
- [x] **Config knobs**: Safe-edit toggles, thresholds, CLI/env overrides, and Settings dialog wiring now ship by default so operators can tune detection sensitivity without code changes. _(Completed — `src/tinkerbell/services/settings.py`, `src/tinkerbell/widgets/dialogs.py`, `app.py`, `tests/test_settings.py`, `tests/test_main_window.py`.)_
- [x] **Revert contract**: Extend the `EditorAdapter`/`DocumentBridge` contract with a safe rollback path (e.g., reloading the saved snapshot without firing cache events) so the `PostEditInspector` can put the editor back exactly where it started before emitting `edit_rejected` telemetry. _(Completed Nov 21, 2025 — `EditorWidget` now exposes `restore_document`, and `DocumentBridge` calls it automatically when the inspector rejects an edit.)_
- [x] **UI signal wiring**: Main window failure handling now parses `edit_rejected` metadata and routes categorized guardrail states through the chat/status widgets so users see the same cause codes emitted by telemetry. _(Completed — `src/tinkerbell/ui/main_window.py`, `src/tinkerbell/ui/telemetry_controller.py`, `tests/test_telemetry_controller.py`.)_

## Workstream D — Testing & Observability
- [x] **Unit tests**: Extend `tests/test_document_apply_patch.py`, `tests/test_document_edit.py`, `tests/test_bridge.py`, and friends to cover hash rejection, range normalization, inspector failures, and controller retry logic. _(Completed Nov 21, 2025 — added metadata regression coverage plus hash/inspector tests in `tests/test_document_apply_patch.py`/`tests/test_bridge.py` and retry telemetry checks in `tests/test_ai_controller.py`.)_
- [x] **Integration tests**: Add pytest-qt flows (in `tests/test_editor_widget.py` or a new `tests/test_safe_ai_edits.py`) that simulate an AI rewrite turn end-to-end, including a forced stale snapshot to ensure the retry path works. _(Completed Nov 21, 2025 — `tests/test_editor_widget.py::test_ai_rewrite_turn_retries_on_stale_snapshot` now drives a real `EditorWidget` + `DocumentBridge` via the AI controller and asserts the guardrail retry path plus telemetry emission.)_
- [x] **Benchmark scripts**: Updated `benchmarks/measure_diff_latency.py` so it times both raw `DiffBuilder` runs and the full `document_apply_patch → DocumentBridge` pipeline (safe edits on/off) with JSON/table outputs and configurable guardrail thresholds.
- [x] **Observability plumbing**: Documented the guardrail telemetry payloads in `docs/ai_v2.md` and created `docs/operations/telemetry.md` with field-level references for `patch.apply`, `edit_rejected`, `patch.anchor`, `diff.streamed`, and `document_edit.retry`.

- [x] **Feature flag**: Add a `safe_ai_edits` toggle to `Settings`/`SettingsRuntime`, surface it in the Settings dialog, and honor CLI/env overrides (`TINKERBELL_SAFE_AI_EDITS=1`). Default to off until QA signs off. _(Completed Nov 21, 2025 — SettingsRuntime now propagates the flag to every tab via `MainWindow`, the CLI exposes `--enable/disable-safe-ai-edits`, and `docs/ai_v2.md` documents the rollout/override workflow.)_
- [ ] **Internal dogfood**: Enable the flag for dev builds, collect metrics on rejection/auto-revert counts, and document findings in `docs/ai_v2_release_notes.md`.
- [ ] **Gradual enablement**: When metrics look good, flip the flag on for a subset of users (or make it default-on while leaving an escape hatch) and monitor telemetry for regressions.
- [ ] **Post-launch checklist**: After general availability, archive baseline metrics, close the tracking issue, and update `fixing_ai.md` with the rollout outcome.

## Cross-Cutting Considerations
- Document every new exception/telemetry field in `docs/ai_v2.md` so agent developers know how to respond to guardrail failures.
- Coordinate UI copy with design so warning toasts remain concise and actionable.
- Keep performance in mind: cache paragraph hashes and re-use diffs already computed during edit application to avoid double work.
